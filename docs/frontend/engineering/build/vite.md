# Vite

## 1. 核心概念

Vite 主要由两个部分组成：

1. **开发服务器**：利用浏览器的 ESM 能力提供源文件，内置丰富功能并支持高效的 HMR（热模块替换）。
2. **生产构建**：在生产环境中使用 Rollup 构建代码，并提供优化构建过程的指令。

Vite 作为基于浏览器原生 ESM 的构建工具，省略了开发环境的打包过程，直接利用浏览器解析 imports，并在服务端按需编译返回。同时，Vite 在开发环境中提供极快的模块热更新，且热更新速度不会随着模块数量增加而变慢。因此，使用 Vite 进行开发，速度至少比 Webpack 快 10 倍。

### 1.1 极速启动

Vite 利用浏览器原生支持 ES 模块（ESM），避免传统打包工具的慢启动时间。通过直接在浏览器中加载 ES 模块，Vite 可以实现毫秒级的启动速度。

**面试题**

1. Vite 如何实现极速启动？
   - Vite 通过利用浏览器原生支持 ES 模块（ESM），避免了传统打包工具的慢启动时间，从而实现了极速启动。

### 1.2 即时更新（HMR）

Vite 提供热模块替换（Hot Module Replacement），在开发过程中实时更新页面。HMR 使得开发者可以在不刷新整个页面的情况下，看到代码的最新变化，大大提高了开发效率。

**面试题**

1. 什么是热模块替换（HMR）？
   - 热模块替换（HMR）是一种在应用程序运行时，替换、添加或删除模块，而无需重新加载整个页面的技术。

### 1.3 ESBuild 加速

Vite 利用 esbuild 提供快速的 JavaScript/TypeScript 转译。esbuild 是一个用 Go 编写的超快速打包工具，能够显著提高构建速度。

**面试题**

1. Vite 如何利用 esbuild 加速构建？
   - Vite 利用 esbuild 提供快速的 JavaScript/TypeScript 转译，从而加速构建过程。

### 1.4 生产优化（Rollup）

在生产模式下，Vite 使用 Rollup 进行高效打包，支持代码拆分和树摇优化。Rollup 是一个强大的 JavaScript 模块打包工具，能够生成高效、优化的代码。

**面试题**

1. Vite 在生产模式下如何进行优化？
   - Vite 在生产模式下使用 Rollup 进行高效打包，支持代码拆分和树摇优化，从而生成高效、优化的代码。

### 1.5 与 webpack 对比

#### 开发环境的速度提升

传统的 JavaScript 构建工具如 Webpack，启动开发服务器通常需要较长时间，这与代码量和复杂度成正比。即便使用 HMR（热模块替换），文件修改后的效果也需要几秒钟才能在浏览器中体现。那么，Vite 是如何解决这些问题的呢？

通过对比 Vite 和 Webpack 在开发环境中的表现，我们发现以下几点差异：

| 构建工具    | 启动方式                                                                                        | HMR 处理方式                                                                                           |
| ----------- | ----------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| **Webpack** | 需要先打包生成 bundle，然后启动开发服务器。                                                     | HMR 时需要重新编译改动模块及其相关依赖。                                                               |
| **Vite**    | 直接启动开发服务器，利用现代浏览器的 ESM（ES 模块）能力，无需打包，直接请求所需模块并实时编译。 | HMR 时只需让浏览器重新请求改动的模块，并利用浏览器的缓存（源码模块协商缓存，依赖模块强缓存）优化请求。 |

Vite 在开发环境中冷启动时，无需打包和分析模块依赖，也无需在启动开发服务器前进行编译。_启动时，Vite 使用 esbuild 进行预构建_。

而 Webpack 启动后，需要经历复杂的编译打包过程，包括语法解析、依赖收集、代码转译、打包合并和代码优化，这些操作在 Node 环境下会导致性能问题。

对于 HMR 的慢速问题，Webpack 即使在小改动时也需要重建完整的模块依赖图。**Vite 利用 ESM 和浏览器缓存技术，使得更新速度与项目复杂度无关。** 像 Snowpack 和 Vite 这样的非打包构建工具，在开发环境中只需启动两个服务器：一个用于页面加载，另一个用于 HMR 的 WebSocket。当浏览器发出原生 ESM 请求时，服务器只需编译当前文件并返回给浏览器，无需管理依赖。

### 1.6 Vite 开发环境与生产环境的优化对比

#### 开发环境优化

在开发环境中，Vite 不需要对所有资源进行打包，而是通过 esbuild 对依赖进行预构建，将 CommonJS 和 UMD 格式的依赖转换为浏览器支持的 ESM 格式。这种方式不仅提升了页面加载性能（如 lodash 的请求），还将构建的依赖缓存到 `node_modules/.vite` 目录下。Vite 会根据 `package.json` 中的 `dependencies` 列表、包管理器的锁文件以及 `vite.config.js` 中的相关配置字段来判断是否需要重新预构建，只要其中之一发生变化，就会触发重新预构建。

此外，开发环境中使用了浏览器缓存技术，解析后的依赖请求通过 HTTP 头的 `max-age=31536000, immutable` 进行强缓存，从而提升页面性能。

#### 生产环境优化

在生产环境中，由于嵌套导入可能导致大量网络请求，即便使用 HTTP/2（多路复用、首部压缩），直接发布未打包的 ESM 仍然会影响性能。因此，Vite 在生产环境中使用更成熟的 Rollup 进行完整的打包过程。虽然 esbuild 的速度很快，但在应用级别的代码分割、CSS 处理上仍不够稳定，并且无法兼容某些未提供 ESM 的 SDK。

为了在生产环境中实现最佳加载性能，仍需进行代码的树摇优化（tree-shaking）、懒加载和 chunk 分割，以获得更好的缓存效果。
